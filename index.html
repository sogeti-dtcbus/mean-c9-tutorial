<!doctype html>
<html>
	<head>
		<meta charset="utf-8">
		<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">

		<title>reveal.js</title>

		<link rel="stylesheet" href="css/reveal.css">
		<link rel="stylesheet" href="css/theme/simple.css">

		<!-- Theme used for syntax highlighting of code -->
		<link rel="stylesheet" href="lib/css/zenburn.css">
        
        <!-- Custom CSS -->
        <link rel="stylesheet" href="css/presentation.css">

		<!-- Printing and PDF exports -->
		<script>
			var link = document.createElement( 'link' );
			link.rel = 'stylesheet';
			link.type = 'text/css';
			link.href = window.location.search.match( /print-pdf/gi ) ? 'css/print/pdf.css' : 'css/print/paper.css';
			document.getElementsByTagName( 'head' )[0].appendChild( link );
		</script>
	</head>
	<body>
		<div class="reveal">
			<div class="slides">
				<section>
                    <img src="images/logo2.png" height="340" width="340"/>
                    <img src="images/mean.png"/>
                    <p>A simple building block application</p>
                </section>
				<section>
                    <p>Let's make a simple building-block contact list application</p>
                    <ul>
                        <li class="fragment">MongoDB - Database</li>
                        <li class="fragment">Express - Server/API</li>
                        <li class="fragment">Angular - Web UI Application</li>
                        <li class="fragment">NodeJS - The technology that makes this stack possible</li>
                    </ul>
                </section>
                <section>
                    <section>
                        <h4>Cloud9 Setup</h4>
                        <ul>
                            <li>We'll be using the Cloud9 online IDE</li>
                            <li>Log into your C9 account</li>
                            <li>Start a HTML workspace</li>
                        </ul>
                    </section>
                    <section>
                        <h4>Node Setup</h4>
                        <ol>
                            <li>Once your fresh workspace has spun up, we’ll be using the c9 bash terminal to update node and npm to the most recent versions. Go ahead and run the following:</li>
                            <pre><code class="hljs" data-trim>$ nvm install node && nvm alias default node && npm update npm -g</code></pre></li>
                            <li>Now, we’ll check to ensure that the latest versions of node and npm are installed (as of April 2017, this tutorial is using node 7.9.0 and npm 4.6.1)</li>
                            <pre><code class="hljs" data-trim>$ node -v</code></pre>
                            <pre><code class="hljs" data-trim>$ npm -v</code></pre>
                        </ol>                        
                    </section>
                    <section>
                        <h4>Angular Setup</h4>
                        <ol>
                            <li>Next, we’ll install the Angular CLI (This can take some time to install...)</li>
                            <pre><code class="hljs" data-trim>$ npm install -g @angular/cli</code></pre>
                            <li>Create your new AngularJS 2 application (This can take some time to build...)</li>
                            <pre><code class="hljs" data-trim>$ ng new mean-app</code></pre>
                        </ol>
                    </section>
                    <section>
                        <h4>Angular Setup</h4>
                        <ol>
                            <li>Once completed, you will now have a ‘mean-app’ project directory, CD into it</li>
                            <pre><code class="hljs" data-trim>$ cd mean-app</code></pre>
                            <li>Now, let’s test it to ensure everything is working correctly</li>
                            <pre><code class="hljs" data-trim>$ ng serve</code></pre>
                        </ol>
                        <p>You should receive: webpack: Compiled successfully</p>
                        <p>Exit the currently running code using CTRL/CMD+C </p>
                    </section>
                    <section>
                        <h4>MongoDB Setup</h4>
                        <ol>
                            <li>Next, we’ll install MongoDB from within the ‘mean-app’ directory</li>
                            <pre><code class="hljs" data-trim>$ sudo apt-get install -y mongodb-org</code></pre>
                            <li>Now, we’ll setup our data storage for MongoDB</li>
                            <pre><code class="hljs" data-trim>
                                $ mkdir data
                                $ echo 'mongod --bind_ip=$IP --dbpath=data --nojournal --rest "$@"' > mongod 
                                $ chmod a+x mongod
                            
                                //-Parameters used for c9
                                //--dbpath=data defaults to /var/db (inaccessible)
                                //--nojournal - mongodb allocates 2GB journal file (c9 quota) 
                                //--bind_ip=$IP - because you can't bind to 0.0.0.0
                                //--rest - runs on default port 28017
                            </code></pre>
                        </ol>                        
                    </section>
                    <section>
                        <h4>MongoDB Setup</h4>
                        <ol>
                            <li>Next, we'll test MongoDB</li>
                            <pre><code class="hljs" data-trim>$ ./mongod</code></pre>
                            <span>Alternatively, you may use the following c9 command to start MongoDB in a hidden terminal (although any errors will be hidden, they can be viewed by checking the referenced file printed after the command</span>
                            <pre><code class="hljs" data-trim>$ nohup ./mongod &</code></pre>
                            <li>Now, we’ll setup our data storage for MongoDB</li>
                        </ol>                        
                    </section>
                    <section>
                        <h4>MongoDB Setup</h4>
                        <ol>
                            <li>With MongoDB successfully running, open a new terminal window in your ‘mean-app’ directory (right-click the directory ‘Open Terminal Here)</li>
                            <li>Now, we’ll need to wire up MongoDB to our node server. We’ll use the touch command, the easiest way to create an empty file using bash, to create our server.js file:</li>
                            <pre><code class="hljs" data-trim>$ touch server.js</code></pre>
                            <li>Once created, open the file to edit it using the c9 Workspace directory explorer</li>
                        </ol>                        
                    </section>
                    <section>
                        <h4>MongoDB Setup</h4>
                        <span class="notes">server.js</span>
                        <pre><code>
var express = require("express"); 
var bodyParser = require("body-parser"); 
var mongodb = require("mongodb"); 
var ObjectID = mongodb.ObjectID; 
var CONTACTS_COLLECTION = "contacts"; 
var app = express(); 

app.use(bodyParser.json()); 

// Create a database variable outside of the database connection callback to reuse the connection pool in your app. 
var db; 

// Connect to the database before starting the application server.

mongodb.MongoClient.connect("mongodb://" + process.env.IP + ":27017", function(err, database) {
    if (err) {
        console.log(err);
        process.exit(1);
    }

    // Save database object from the callback for reuse.
    db = database;
    console.log("Database connection ready");

    // Initialize the app.
    var server = app.listen(process.env.PORT || 8080, function() {
        var port = server.address().port;
        console.log("App now running on port", port);
    });
}); 
// Save database object from the callback for reuse. 
// CONTACTS API ROUTES BELOW
                        </code></pre>
                        <p class="notes">We want to use our database connection pool as often as possible to best manage our available resources. We initialize the db variable in the global scope so that the connection can be used by all the route handlers. We initialize the app only after the database connection is ready. This ensures that the application won’t crash or error out by trying database operations before the connection is established.</p>
                    </section>
                    <section>
                        <h4>Express Setup</h4>
                        <ol>
                            <li>The express app requires a few different libraries. We’ll want to install these libraries and save the dependencies to our package.json file so that they will also be installed when we deploy the application.</li>
                            <pre><code>$ npm install mongodb express body-parser --save</code></pre>
                            <li>We’ll now create a RESTful API server with node and Express. We need to define the endpoints (or data) we would like to expose. In your server.js file, append the following code (continued infollowing pages)</li>
                        </ol>
                    </section>
                    <section>
                        <h4>Express Setup</h4>
                        <span class="notes">server.js</span>
                        <pre><code>
// Generic error handler used by all endpoints.
function handleError(res, reason, message, code) {
    console.log("ERROR: " + reason);
    res.status(code || 500).json({
        "error": message
    });
}
/*  "/api/contacts"
 *    GET: finds all contacts
 *    POST: creates a new contact
 */

app.get("/api/contacts", function(req, res) {
    db.collection(CONTACTS_COLLECTION).find({}).toArray(function(err, docs) {
        if (err) {
            handleError(res, err.message, "Failed to get contacts.");
        } else {
            res.status(200).json(docs);
        }
    });
});

app.post("/api/contacts", function(req, res) {
    var newContact = req.body;
    newContact.createDate = new Date();
    if (!req.body.name) {
        handleError(res, "Invalid user input", "Must provide a name.", 400);
    }
    db.collection(CONTACTS_COLLECTION).insertOne(newContact, function(err, doc) {
        if (err) {
            handleError(res, err.message, "Failed to create new contact.");
        } else {
            res.status(201).json(doc.ops[0]);
        }
    });
});

/*  "/api/contacts/:id"
 *    GET: find contact by id
 *    PUT: update contact by id
 *    DELETE: deletes contact by id
 */

app.get("/api/contacts/:id", function(req, res) {
    db.collection(CONTACTS_COLLECTION).findOne({
        _id: new ObjectID(req.params.id)
    }, function(err, doc) {
        if (err) {
            handleError(res, err.message, "Failed to get contact");
        } else {
            res.status(200).json(doc);
        }
    });
});

app.put("/api/contacts/:id", function(req, res) {
    var updateDoc = req.body;
    delete updateDoc._id;
    db.collection(CONTACTS_COLLECTION).updateOne({_id: new ObjectID(req.params.id)}, updateDoc, function(err, doc) {
        if (err) {
            handleError(res, err.message, "Failed  to  update  contact");
        } else {
            updateDoc._id = req.params.id;
            res.status(200).json(updateDoc);
        }
    });
});

app.delete("/api/contacts/:id", function(req, res) {
    db.collection(CONTACTS_COLLECTION).deleteOne({_id: new ObjectID(req.params.id)}, function(err, result) {
        if (err) {
            handleError(res, err.message, "Failed  to  delete  contact");
        } else {
            res.status(200).json(req.params.id);
        }
    });
});
                        </code></pre>
                        <p class="notes">
                            The above code implements the API endpoints and adds in database logic so that each contact will have the following schema<br>
                            <code>
                                {   "_id": ObjectId,   "name": string,   "email": string,   "phone": { "mobile": string, "work": string }   }
                            </code>
                        </p>
                    </section>
                    <section>
                        <h4>Test Endpoints</h4>
                        <p>We’ve  reached  the  point  that  we  can  now  test  our  endpoints  to  confirm  everything  is  working  properly so far. Open your package.json file and replace the ‘start’ script with</p>
                        <pre><code>$"start": "node server.js"</code></pre>
                        <p>Perform some pre-test checks:</p>
                        <ul>
                            <li>Ensure that you’re in a bash terminal in the ‘mean-app’ directory</li>
                            <li>Ensure that your MongoDB is running</li>
                            <li>Ensure that you have saved your server.js and package.json files</li>
                        </ul>
                    </section>
                    <section>
                        <h4>Test Endpoints</h4>
                        <span>Kick off your server.js file by running</span>
                        <pre><code>$  node server.js</code></pre>
                        <span>A new terminal window will open, and if all is successful you should see the following output</span>
                        <pre><code>
Your code is running at https://your-project-name.c9users.io. 
Important: use process.env.PORT as the port and process.env.IP as the host in your scripts! (node:7793)
DeprecationWarning: node --debug is deprecated. 
Please use node --inspect instead. 
Debugger listening on 127.0.0.1:15454
Database connection ready
App now running on port 8080
                        </code></pre>
                    </section>
                    <section>
                        <h4>Test Endpoints</h4>
                        <span>The application is now live. We’ll use cURL to issue a POST request from a bash terminal</span>
                        <pre><code>$ curl -H "Content-Type: application/json" -d '{"name":"ST Saw Sharpening", "email": "sogeti-dtcbus@gmail.com"}' https://your-project-name.c9users.io/api/contacts</code></pre>
                        <span>Once you issue the POST request, if successful, you will immediately be presented with the output array we setup with our endpoints</span>
                        <pre><code>
{
    "name":"ST Saw Sharpening",
    "email":"sogeti-dtcbus@gmail.com",
    "createDate":"2017-04-27T23:56:23.179Z",
    "_id":"590285276deeac1e715242da"
} 
                        </code></pre>
                    </section>
                    <section>
                        <p><span>Now, open a browser window and go to the https://your-project-name.c9users.io/api/contactsURL to see that you have indeed posted a request and the array is now stored in MongoDB!</span></p>
                    </section>
                </section>
			</div>
		</div>

		<script src="lib/js/head.min.js"></script>
		<script src="js/reveal.js"></script>

		<script>
			// More info about config & dependencies:
			// - https://github.com/hakimel/reveal.js#configuration
			// - https://github.com/hakimel/reveal.js#dependencies
			Reveal.initialize({
				dependencies: [
					{ src: 'plugin/markdown/marked.js' },
					{ src: 'plugin/markdown/markdown.js' },
					{ src: 'plugin/notes/notes.js', async: true },
					{ src: 'plugin/highlight/highlight.js', async: true, callback: function() { hljs.initHighlightingOnLoad(); } }
				]
			});
		</script>
	</body>
</html>
